<!DOCTYPE html>
<html>

<head>
    <title>Chatbot Site</title>
    <!--Fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,600,800" rel="stylesheet">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

    <!--https://fontawesome.com/license for license-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ"
        crossorigin="anonymous">

    <link rel="stylesheet" href="files/style.css">
</head>

<body>
    <nav class="navbar navbar-expand-sm ontop">

        <!-- Links -->
        <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown">
                <div class="btn dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="dropdown-menu dropdown-menu-right" id="test" aria-labelledby="navbarDropdown">
                    <div>
                        <p>Connect to a new room</p>
                        <input type="text" class="form-control" autocomplete="off" placeholder="Enter Room ID" id="roomInput">
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" data-toggle="modal" data-target="#roomIDModal">Get Current Room ID</a>
                    <a class="dropdown-item" data-toggle="modal" data-target="#creditsModal">Credits</a>
                </div>
            </li>
        </ul>

    </nav>
    <div class="modal fade" id="roomIDModal">
        <div class="modal-dialog modal-dialog-centered" style="width: fit-content; min-width: 150px;">
            <div class="modal-content">

                <!-- Modal body -->
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h6 class="modal-title">Room ID</h6>
                    <h1 class="modal-title roomID"></h1>
                </div>

            </div>
        </div>
    </div>
    <div class="modal fade" id="creditsModal">
        <div class="modal-dialog modal-dialog-centered" style="width: 300px;">
            <div class="modal-content">

                <!-- Modal body -->
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h6 class="modal-title">Creator</h6>
                    <h1 class="modal-title">Aamir Tahir</h1>
                </div>

            </div>
        </div>
    </div>
    <div class="headerText">
        <h1 class="unselectable">Secure Chat</h1>
        <div>
            <h4 class="unselectable">Your Room ID:</h4>
            <h2 id="roomID" class="roomID"></h2>
        </div>
    </div>
    <div class="centered unselectable" id="nickDialog">
        <h3 style="text-align: center;">Choose a nickname to begin</h3>
        <div class="input-group">
            <input type="text" class="form-control" autocomplete="off" placeholder="Choose a Nickname" id="nickInput">
            <span class="input-group-btn">
                <button class="btn btn-success submit-btn" type="button" id="nickBtn">Join</button>
            </span>
        </div>
    </div>
    <div class="centered unselectable hidden" id="chatDialog">
        <div class="form-group receivedMsg" id="chatMessages">
            <div class="typewriter">
                <p>This is a sample received message.</p>
            </div>
        </div>
        <div class="input-group">
            <input type="text" class="form-control" autocomplete="off" placeholder="Enter message" id="chatSendInput">
            <span class="input-group-btn">
                <button class="btn btn-success submit-btn" type="button" id="chatSendBtn">Send</button>
            </span>
        </div>
    </div>
    <div class="bgPattern"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io('http://localhost:8082');
        var roomID = 0;

        socket.emit('new connection', function (data) {
            queryRoom = getQueryItems()['room'];
            if (queryRoom) {
                queryRoom = queryRoom.substring(0, 20);
            }
            roomID = queryRoom || data + 1;
            $('.roomID').text(roomID);
        });

        //Clicking join button
        $('#nickBtn').click(function (event) {
            socket.emit('new user', { nickname: $('#nickInput').val().toLowerCase(), room: roomID }, function (data) {
                if (data) {
                    $('#nickDialog').addClass('hidden');
                    $('#nickInput').val("");
                    $('#chatDialog').removeClass('hidden');
                } else {
                    console.log("Cannot use that username!");
                    $('#nickInput').val("Cannot use that username!");
                }
            });
        });

        //Pressing enter on nickname input
        $('#nickInput').keyup(function (event) {
            if (event.keyCode === 13) {
                socket.emit('new user', { nickname: $('#nickInput').val().toLowerCase(), room: roomID }, function (data) {
                    if (data) {
                        $('#nickDialog').addClass('hidden');
                        $('#nickInput').val("");
                        $('#chatDialog').removeClass('hidden');
                    } else {
                        console.log("Cannot use that username!");
                        $('#nickInput').val("Cannot use that username!");
                    }
                });
            }
        });

        //Pressing enter on nickname input
        $('#roomInput').keyup(function (event) {
            if (event.keyCode === 13) {
                socket.emit('change room', { room: $('#roomInput').val().toLowerCase().trim() }, function (data) {
                    if (data) {
                        roomID = $('#roomInput').val().toLowerCase();
                        $('.roomID').text(roomID);
                        $('#roomInput').attr("placeholder","Enter Room ID");
                    } else {
                        console.log("Invalid Room");
                        $('#roomInput').attr("placeholder","Invalid Room");
                    }
                    $('#roomInput').val('');
                });
            }
        });
        //Clicking Send button
        $('#chatSendBtn').click(function (event) {
            socket.emit('message', $('#chatSendInput').val());
            message = $('#chatSendInput').val();
            writeMessageToChat('plainMessage', message);
            $('#chatSendInput').val("");
        });

        //Pressing enter on input
        $('#chatSendInput').keyup(function (event) {
            if (event.keyCode === 13) {
                socket.emit('message', $('#chatSendInput').val());
                message = $('#chatSendInput').val();
                writeMessageToChat('plainMessage', message);
                $('#chatSendInput').val("");
            }
        });

        socket.on('message', function (message) {
            writeMessageToChat('plainMessage', message);
        });

        function writeMessageToChat(fn, ...params) {
            function plainMessage(message) {
                console.log(message);
                lines = message.match(/.{1,62}/g);
                lines.forEach(element => {
                    $('#chatMessages').append($('<div class="typewriter">').append($('<p>').text(element)));
                });
            }
            if (fn.match(/\W/)) {
                throw "invalid function name";
            }
            var func = eval(fn);
            func(...params);
            $('#chatMessages').scrollTop($('#chatMessages').prop("scrollHeight"));
        }

        function getQueryItems() {
            query = {};
            regex = new RegExp(/(?<=(&|\?))\w+=\w+/g);
            while ((result = regex.exec(window.location)) !== null) {
                queryArray = result[0].split("=")
                query[queryArray[0]] = queryArray[1];
            }
            return query;
        }
    </script>
</body>

</html>